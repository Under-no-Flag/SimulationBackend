# 两套参数使用指南

## 概述

现在支持两套独立的参数设置：
1. **引擎参数（Engine Parameters）**: 设置ExperimentSimulation引擎的参数
2. **智能体参数（Agent Parameters）**: 设置Main智能体的参数

## 数据库结构

### 新增字段
```sql
-- 引擎参数字段
engine_parameters TEXT COMMENT '引擎参数JSON字符串'

-- 智能体参数字段  
agent_parameters TEXT COMMENT '智能体参数JSON字符串'
```

### 字段说明
- `engine_parameters`: 存储引擎相关参数的JSON字符串
- `agent_parameters`: 存储智能体相关参数的JSON字符串
- 两个字段都是TEXT类型，支持存储复杂的JSON结构

## API接口

### 启动仿真接口
```http
POST /api/simulation/start
Content-Type: application/json

{
  "modelName": "NanJingDong",
  "engineParameters": {
    "startDate": "2025-05-31 15:30:00",
    "stopDate": "2025-05-31 15:40:00", 
    "realTimeScale": 1000
  },
  "agentParameters": {
    "simulTargetTime": "2025-05-31 15:30:00"
  },
  "description": "测试仿真运行"
}
```

### 参数说明

#### 引擎参数（engineParameters）
| 参数名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| startDate | String | 仿真开始时间 | "2025-05-31 15:30:00" |
| stopDate | String | 仿真结束时间 | "2025-05-31 15:40:00" |
| realTimeScale | Number | 实时时间比例 | 1000 |

#### 智能体参数（agentParameters）
| 参数名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| simulTargetTime | String | 仿真目标时间 | "2025-05-31 15:30:00" |

## 代码实现

### 1. 数据库实体修改
```java
@Entity
@Table(name = "simulation_runs")
public class SimulationRun {
    // ... 其他字段 ...
    
    @Column(name = "engine_parameters", columnDefinition = "TEXT")
    private String engineParameters;
    
    @Column(name = "agent_parameters", columnDefinition = "TEXT")
    private String agentParameters;
    
    // getter和setter方法
}
```

### 2. Controller修改
```java
public static class SimulationStartRequest {
    private String modelName;
    private Map<String, Object> engineParameters;  // 引擎参数
    private Map<String, Object> agentParameters;   // 智能体参数
    private String description;
    
    // getter和setter方法
}
```

### 3. Service方法
```java
public SimulationRun createAndStartSimulation(
    String modelName, 
    String engineParameters, 
    String agentParameters, 
    String description
) {
    // 创建仿真记录
    SimulationRun simulationRun = new SimulationRun();
    simulationRun.setEngineParameters(engineParameters);
    simulationRun.setAgentParameters(agentParameters);
    // ...
}
```

### 4. 参数应用方法
```java
// 应用引擎参数
private void applyEngineParameters(Simulation experiment, String engineParametersJson) {
    // 解析JSON并设置引擎参数
    Object engine = experiment.getEngine();
    // 设置 startDate, stopDate, realTimeScale 等
}

// 应用智能体参数  
private void applyAgentParameters(Simulation experiment, String agentParametersJson) {
    // 解析JSON并设置智能体参数
    Object mainAgent = getMainAgent(experiment);
    // 设置 simulTargetTime 等
}
```

## 使用示例

### 1. 基本使用
```bash
curl -X POST http://localhost:9527/api/simulation/start \
  -H "Content-Type: application/json" \
  -d '{
    "modelName": "NanJingDong",
    "engineParameters": {
      "startDate": "2025-05-31 15:30:00",
      "stopDate": "2025-05-31 15:40:00",
      "realTimeScale": 1000
    },
    "agentParameters": {
      "simulTargetTime": "2025-05-31 15:30:00"
    },
    "description": "测试仿真"
  }'
```

### 2. 只设置引擎参数
```bash
curl -X POST http://localhost:9527/api/simulation/start \
  -H "Content-Type: application/json" \
  -d '{
    "modelName": "NanJingDong",
    "engineParameters": {
      "startDate": "2025-05-31 15:30:00",
      "realTimeScale": 1000
    },
    "description": "只设置引擎参数"
  }'
```

### 3. 只设置智能体参数
```bash
curl -X POST http://localhost:9527/api/simulation/start \
  -H "Content-Type: application/json" \
  -d '{
    "modelName": "NanJingDong",
    "agentParameters": {
      "simulTargetTime": "2025-05-31 15:30:00"
    },
    "description": "只设置智能体参数"
  }'
```

## 参数映射关系

### 引擎参数映射
| JSON参数 | AnyLogic方法 | 说明 |
|----------|-------------|------|
| startDate | engine.setStartDate() | 设置仿真开始时间 |
| stopDate | engine.setStopDate() | 设置仿真结束时间 |
| realTimeScale | engine.setRealTimeScale() | 设置实时时间比例 |

### 智能体参数映射
| JSON参数 | AnyLogic方法 | 说明 |
|----------|-------------|------|
| simulTargetTime | mainAgent.setParameter() | 设置仿真目标时间 |

## 错误处理

### 1. 参数验证
- 引擎参数和智能体参数都是可选的
- 如果参数为空或格式错误，会使用默认值
- 参数设置失败不会中断仿真运行

### 2. 日志记录
```
INFO  - 开始应用引擎参数: {startDate=2025-05-31 15:30:00, realTimeScale=1000}
INFO  - ✓ 成功设置引擎参数: startDate = 2025-05-31 15:30:00
INFO  - ✓ 成功设置引擎参数: realTimeScale = 1000
INFO  - 开始应用智能体参数: {simulTargetTime=2025-05-31 15:30:00}
INFO  - ✓ 成功设置智能体参数: simulTargetTime = 2025-05-31 15:30:00
```

## 兼容性说明

### 1. 向后兼容
- 保留了原有的`simulation_parameters`字段
- 旧的API调用仍然有效
- 新的两套参数系统是可选的

### 2. 迁移建议
- 新项目建议使用两套参数系统
- 旧项目可以逐步迁移
- 两种方式可以并存

## 最佳实践

### 1. 参数组织
- 引擎参数：控制仿真时间和运行模式
- 智能体参数：控制业务逻辑和模型行为
- 保持参数分类清晰

### 2. 参数命名
- 使用有意义的参数名
- 保持命名一致性
- 添加参数说明文档

### 3. 错误处理
- 提供合理的默认值
- 记录详细的错误日志
- 支持参数验证

## 总结

通过引入两套参数系统，实现了：
- ✅ 更清晰的参数分类
- ✅ 更灵活的配置管理
- ✅ 更好的代码可维护性
- ✅ 向后兼容性保证

这种设计使得仿真参数的管理更加规范和灵活，为后续的功能扩展提供了良好的基础。
