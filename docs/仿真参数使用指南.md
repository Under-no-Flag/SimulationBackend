# 仿真参数使用指南

## 概述

本文档介绍如何使用新的仿真参数功能，支持通过JSON格式的键值对来配置仿真模型参数。

## 功能特点

- ✅ 支持多种数据类型（字符串、整数、浮点数、布尔值等）
- ✅ 自动类型转换和验证
- ✅ JSON格式存储，灵活扩展
- ✅ 反射机制动态赋值
- ✅ 错误处理和日志记录

## 接口使用

### 1. 启动仿真接口

**接口地址**: `POST /api/simulation/start`

**请求格式**:
```json
{
  "modelName": "NanJingDong",
  "description": "测试仿真运行",
  "parameters": {
    "simulTargetTime": "2025-05-31 12:30:00",
    "pedestrianCount": 1000,
    "simulationSpeed": 1.0,
    "weatherCondition": "sunny",
    "enableLogging": true,
    "maxWalkingSpeed": 1.5,
    "minWalkingSpeed": 0.8,
    "emergencyExitEnabled": false,
    "crowdDensityThreshold": 0.8
  }
}
```

**响应格式**:
```json
{
  "success": true,
  "message": "模拟启动成功",
  "data": {
    "runId": 123,
    "modelName": "NanJingDong",
    "startDate": "2025-01-20T10:30:00",
    "status": "RUNNING",
    "simulationParameters": "{\"simulTargetTime\":\"2025-05-31 12:30:00\",\"pedestrianCount\":1000,...}",
    "description": "测试仿真运行"
  }
}
```

### 2. 支持的参数类型

| 参数类型 | Java类型 | 示例值 | 说明 |
|---------|---------|-------|------|
| 字符串 | String | "2025-05-31 12:30:00" | 时间、描述等文本信息 |
| 整数 | int/Integer | 1000 | 行人数量、迭代次数等 |
| 浮点数 | double/Double | 1.5 | 速度、密度等小数值 |
| 布尔值 | boolean/Boolean | true | 开关状态 |
| 长整型 | long/Long | 1000000L | 大数值 |
| 单精度浮点 | float/Float | 1.5f | 单精度小数 |

### 3. 常用参数说明

| 参数名 | 类型 | 说明 | 示例值 |
|-------|------|------|-------|
| simulTargetTime | String | 仿真目标时间 | "2025-05-31 12:30:00" |
| pedestrianCount | Integer | 行人数量 | 1000 |
| simulationSpeed | Double | 仿真速度倍率 | 1.0 |
| weatherCondition | String | 天气条件 | "sunny", "rainy", "cloudy" |
| enableLogging | Boolean | 是否启用日志 | true |
| maxWalkingSpeed | Double | 最大行走速度 | 1.5 |
| minWalkingSpeed | Double | 最小行走速度 | 0.8 |
| emergencyExitEnabled | Boolean | 是否启用紧急出口 | false |
| crowdDensityThreshold | Double | 人群密度阈值 | 0.8 |

## 使用示例

### JavaScript/前端调用

```javascript
// 基础参数示例
const basicParameters = {
    simulTargetTime: "2025-05-31 12:30:00",
    pedestrianCount: 1000,
    simulationSpeed: 1.0,
    weatherCondition: "sunny",
    enableLogging: true
};

// 启动仿真
async function startSimulation() {
    const response = await fetch('/api/simulation/start', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            modelName: "NanJingDong",
            description: "前端测试仿真",
            parameters: basicParameters
        })
    });
    
    const result = await response.json();
    if (result.success) {
        console.log('仿真启动成功:', result.data);
    } else {
        console.error('仿真启动失败:', result.message);
    }
}
```

### Java测试代码

```java
// 使用测试助手类
Map<String, Object> parameters = SimulationParameterHelper.createBasicTestParameters();

// 自定义参数
Map<String, Object> customParameters = new HashMap<>();
customParameters.put("simulTargetTime", "2025-05-31 12:30:00");
customParameters.put("pedestrianCount", 1500);
customParameters.put("simulationSpeed", 2.0);

// 验证参数
boolean isValid = SimulationParameterHelper.validateParameters(customParameters);
if (isValid) {
    String json = SimulationParameterHelper.parametersToJson(customParameters);
    // 使用json启动仿真...
}
```

### cURL命令示例

```bash
curl -X POST http://localhost:9527/api/simulation/start \
  -H "Content-Type: application/json" \
  -d '{
    "modelName": "NanJingDong",
    "description": "cURL测试仿真",
    "parameters": {
      "simulTargetTime": "2025-05-31 12:30:00",
      "pedestrianCount": 1000,
      "simulationSpeed": 1.0,
      "weatherCondition": "sunny",
      "enableLogging": true
    }
  }'
```

## 数据库存储

参数以JSON格式存储在`simulation_runs`表的`simulation_parameters`字段中：

```sql
-- 查看存储的参数
SELECT run_id, model_name, simulation_parameters 
FROM simulation_runs 
WHERE run_id = 123;

-- 示例输出
-- {"simulTargetTime":"2025-05-31 12:30:00","pedestrianCount":1000,"simulationSpeed":1.0,...}
```

## 参数赋值原理

系统使用以下方式将参数赋值给模型：

1. **字段直接赋值**: 通过反射直接设置模型中的同名字段
2. **Setter方法调用**: 如果字段不存在，尝试调用对应的setter方法
3. **自动类型转换**: 根据目标类型自动转换参数值
4. **错误处理**: 记录无法设置的参数，但不中断仿真

```java
// 示例：这样的代码会自动执行
// mainAgent.simulTargetTime = "2025-05-31 12:30:00";
// mainAgent.setPedestrianCount(1000);
// mainAgent.setSimulationSpeed(1.0);
```

## 错误处理

### 常见错误类型

1. **参数不存在**: 模型中没有对应的字段或setter方法
2. **类型转换错误**: 无法将参数值转换为目标类型
3. **JSON解析错误**: 参数格式不正确
4. **参数验证失败**: 参数值超出合理范围

### 错误日志示例

```
2025-01-20 10:30:00 INFO  - ✓ 成功设置参数: simulTargetTime = 2025-05-31 12:30:00
2025-01-20 10:30:00 INFO  - ✓ 成功设置参数: pedestrianCount = 1000
2025-01-20 10:30:00 ERROR - × 设置参数失败: invalidParam = value, 错误: 找不到参数: invalidParam
```

## 扩展新参数

要添加新的仿真参数，只需：

1. 在AnyLogic模型中添加对应的字段或属性
2. 在请求中包含该参数
3. 系统会自动尝试设置该参数

```java
// 在模型的Main agent中添加新字段
public class Main extends Agent {
    public String newParameter = "defaultValue";
    // 或者使用setter方法
    public void setNewParameter(String value) {
        this.newParameter = value;
    }
}
```

```json
// 在请求中使用新参数
{
  "parameters": {
    "newParameter": "customValue",
    "existingParam": 123
  }
}
```

## 最佳实践

1. **参数命名**: 使用清晰、一致的参数名
2. **类型一致**: 确保参数值类型与模型中的字段类型匹配
3. **范围验证**: 在客户端和服务端都进行参数范围验证
4. **错误处理**: 合理处理参数设置失败的情况
5. **文档更新**: 及时更新参数文档和示例

## 技术支持

如有问题，请查看：
- 应用日志：关键参数设置信息和错误
- 数据库记录：`simulation_runs.simulation_parameters`字段
- 测试用例：`SimulationParameterTest.java`
